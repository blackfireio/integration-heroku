#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

# debug
#set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

BF_DIR=".blackfire"
BF_BIN_DIR="$BF_DIR/bin"
BF_AGENT_RUN_DIR="$BF_DIR/var/run"
BF_AGENT_SOCKET="/app/${BF_AGENT_RUN_DIR}/agent.sock"
BF_AGENT_LOG_DIR="$BF_DIR/var/log"
BF_AGENT_CONFIG_FILE="$BF_DIR/etc/agent"
BF_CLIENT_CONFIG_FILE=".blackfire.ini"

BF_BUILD_INSTALL_DIR="$BUILD_DIR/$BF_DIR"
BF_BUILD_BIN_DIR="$BUILD_DIR/$BF_BIN_DIR"
BF_BUILD_AGENT_RUN_DIR="$BUILD_DIR/$BF_AGENT_RUN_DIR"
BF_BUILD_AGENT_CONFIG_FILE="$BUILD_DIR/$BF_AGENT_CONFIG_FILE"
BF_BUILD_CLIENT_CONFIG_FILE="$BUILD_DIR/$BF_CLIENT_CONFIG_FILE"
BF_BUILD_LOG_DIR="$BUILD_DIR/$BF_AGENT_LOG_DIR"
BF_CACHE_DIR="$CACHE_DIR/$BF_DIR"

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

if [ ! -f "$ENV_DIR/BLACKFIRE_SERVER_ID" ] ; then
  error "BLACKFIRE_SERVER_ID config variable must be defined!"
fi

# Provisioning credentials from config vars.
BLACKFIRE_SERVER_ID=$(cat $ENV_DIR/BLACKFIRE_SERVER_ID)
BLACKFIRE_SERVER_TOKEN=$(cat $ENV_DIR/BLACKFIRE_SERVER_TOKEN)
BLACKFIRE_CLIENT_ID=$(cat $ENV_DIR/BLACKFIRE_CLIENT_ID)
BLACKFIRE_CLIENT_TOKEN=$(cat $ENV_DIR/BLACKFIRE_CLIENT_TOKEN)
BLACKFIRE_LOG_LEVEL="1"
if [ -f "$ENV_DIR/BLACKFIRE_LOG_LEVEL" ] ; then
  BLACKFIRE_LOG_LEVEL=$(cat $ENV_DIR/BLACKFIRE_LOG_LEVEL)
fi
BLACKFIRE_COLLECTOR="https://blackfire.io"
if [ -f "$ENV_DIR/BLACKFIRE_COLLECTOR" ] ; then
  BLACKFIRE_COLLECTOR=$(cat $ENV_DIR/BLACKFIRE_COLLECTOR)
fi

mkdir -p "$BF_BUILD_INSTALL_DIR" "$BF_BUILD_BIN_DIR" "$BF_BUILD_AGENT_RUN_DIR" "$BF_BUILD_LOG_DIR" "$BF_CACHE_DIR"

if [ -f "$BF_CACHE_DIR/AGENT_VERSION" ] ; then
  BF_AGENT_INSTALLED_VERSION=$(cat "$BF_CACHE_DIR/AGENT_VERSION")
else
  BF_AGENT_INSTALLED_VERSION="0.1"
fi

# Get the latest available version and compare it with the current installed one.
BF_AGENT_VERSION=$(curl -s -I https://blackfire.io/api/v1/releases/agent/linux/amd64 | grep 'X-Blackfire-Release-Version: ' | sed "s%X-Blackfire-Release-Version: %%" | sed s%.$%%)

if [[ "$BF_AGENT_INSTALLED_VERSION" == "$BF_AGENT_VERSION" ]] ; then
  topic "Blackfire agent is already up-to-date"
else
  topic "Installing the latest version of Blackfire agent"
  echo "New agent version is ${BF_AGENT_VERSION}" | indent
  curl -A "Heroku" -o agent.tar.gz -L -s https://blackfire.io/api/v1/releases/agent/linux/amd64
  tar -xzf agent.tar.gz
  chmod +x agent
  cp agent ${BF_BUILD_BIN_DIR}/blackfire-agent
  rm agent.tar.gz agent agent.sha1

  topic "Installing blackfire CLI client"
  curl -A "Heroku" -o ${BF_BUILD_BIN_DIR}/blackfire -s https://packages.blackfire.io/binaries/blackfire-agent/${BF_AGENT_VERSION}/blackfire-cli-linux_amd64
  chmod +x ${BF_BUILD_BIN_DIR}/blackfire
fi

# Configure the agent and the client.
topic "Blackfire configuration"
echo "Configuring the agent" | indent
$BF_BUILD_BIN_DIR/blackfire-agent --register \
    --server-id=$BLACKFIRE_SERVER_ID \
    --server-token=$BLACKFIRE_SERVER_TOKEN \
    --config=$BF_BUILD_AGENT_CONFIG_FILE \
    --socket=unix://${BF_AGENT_SOCKET} \
    --log-level=${BLACKFIRE_LOG_LEVEL} \
    --collector=${BLACKFIRE_COLLECTOR}

echo "Configuring the client" | indent
$BF_BUILD_BIN_DIR/blackfire config \
    --client-id=$BLACKFIRE_CLIENT_ID \
    --client-token=$BLACKFIRE_CLIENT_TOKEN \
    --config=$BF_BUILD_CLIENT_CONFIG_FILE

# Provision the startup profile script.
topic "Writing profile script"
mkdir -p $BUILD_DIR/.profile.d

cat <<EOF > ${BUILD_DIR}/.profile.d/blackfire-agent.sh
export PATH="/app/${BF_BIN_DIR}:$PATH"
export BLACKFIRE_LOG_FILE="/app/${BF_AGENT_LOG_DIR}/probe.log"
export BLACKFIRE_LOG_LEVEL=\${BLACKFIRE_LOG_LEVEL:-"1"}
export BLACKFIRE_COLLECTOR=\${BLACKFIRE_COLLECTOR:-"https://blackfire.io"}
export BLACKFIRE_ENDPOINT=\${BLACKFIRE_ENDPOINT:-"https://blackfire.io"}
export BLACKFIRE_AGENT_SOCKET="unix://${BF_AGENT_SOCKET}"

if [ ! -f ${BF_AGENT_SOCKET} ] ; then
  touch "${BF_AGENT_SOCKET}"
  blackfire-agent \
      --config=/app/${BF_AGENT_CONFIG_FILE} \
      --log-file="/app/${BF_AGENT_LOG_DIR}/agent.log" &
fi
EOF

topic "Blackfire agent and CLI tool are now installed."
${BF_BUILD_BIN_DIR}/blackfire-agent -v | indent
${BF_BUILD_BIN_DIR}/blackfire version | indent
